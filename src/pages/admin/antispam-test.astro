---
import Layout from '../../layouts/Layout.astro';

// Server-side authentication check
const cookies = Astro.cookies;
const authToken = cookies.get('admin_auth_token');
const isAuthenticated = authToken?.value === process.env.ADMIN_AUTH_TOKEN;

// Redirect if not authenticated
if (!isAuthenticated && Astro.request.method === 'GET') {
  return Astro.redirect('/admin/login');
}
---

<Layout title="Anti-Spam Dashboard Test | GadgetFix Admin">
  <div class="admin-container">
    <h1>SpamGuard Dashboard - Test Environment</h1>
    <div id="dashboard-content">
      <h2>Dashboard Content</h2>
      <p>You are logged in securely!</p>
      <button id="logout-btn">Logout</button>
    </div>
  </div>
</Layout>

<style>
  .admin-container {
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }
  
  #dashboard-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  #logout-btn {
    background: #dc2626;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  #logout-btn:hover {
    background: #b91c1c;
  }
</style>

<script>
  // Secure logout functionality
  document.addEventListener('DOMContentLoaded', () => {
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/admin/logout', {
            method: 'POST',
            credentials: 'same-origin'
          });
          if (response.ok) {
            window.location.href = '/admin/login';
          }
        } catch (error) {
          console.error('Logout failed:', error);
        }
      });
    }
  });
</script>